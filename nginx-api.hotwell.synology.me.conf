# HTTP сервер для Let's Encrypt ACME challenge
server {
    listen 80;
    listen [::]:80;
    server_name api.hotwell.synology.me;

    # Let's Encrypt ACME challenge
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    # Временно редирект на HTTPS (после получения сертификата)
    # До получения сертификата закомментируйте следующую строку
    location / {
        return 301 https://$host$request_uri;
    }
    
    # Раскомментируйте для тестирования HTTP до получения сертификата:
    # location / {
    #     proxy_pass http://10.8.0.2:5001;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }
}

# HTTPS сервер
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.hotwell.synology.me;

    # SSL сертификаты (добавляются автоматически certbot)
    # Раскомментируйте после получения сертификата:
    # ssl_certificate /etc/letsencrypt/live/api.hotwell.synology.me/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/api.hotwell.synology.me/privkey.pem;
    
    # SSL настройки (certbot добавит их автоматически, но можно настроить вручную)
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers HIGH:!aNULL:!MD5;
    # ssl_prefer_server_ciphers on;

    # Настройки для больших файлов/видео
    client_max_body_size 2g;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    sendfile on;
    tcp_nopush on;

    # Отключение буферизации для поддержки Range запросов (критично!)
    proxy_buffering off;
    proxy_request_buffering off;

    # CORS заголовки
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type,Range,Origin,Accept" always;
    add_header Access-Control-Expose-Headers "Content-Length,Content-Range,Accept-Ranges" always;

    # Обработка OPTIONS запросов (preflight)
    if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization,Content-Type,Range,Origin,Accept" always;
        add_header Access-Control-Max-Age 1728000 always;
        add_header Content-Type "text/plain charset=UTF-8" always;
        add_header Content-Length 0 always;
        return 204;
    }

    # Health check endpoint
    location /health {
        proxy_pass http://10.8.0.2:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Быстрый ответ для health checks
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
    }

    # Специальный location для медиа файлов с полной поддержкой Range
    location /api/media/ {
        proxy_pass http://10.8.0.2:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Критично для Range запросов - НЕ буферизировать!
        proxy_buffering off;
        proxy_request_buffering off;
        
        # Передача Range заголовков
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        
        # Увеличенные таймауты для больших файлов
        proxy_connect_timeout 60s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        
        # Не скрывать заголовки Range от клиента
        proxy_hide_header Content-Length;
        proxy_hide_header Accept-Ranges;
        
        # Дополнительные заголовки для видео стриминга
        add_header Accept-Ranges bytes always;
    }

    # Основной location для всех остальных запросов
    location / {
        proxy_pass http://10.8.0.2:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Поддержка Range для остальных запросов тоже
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        
        # Стандартные таймауты
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # Логирование
    access_log /var/log/nginx/api.hotwell.access.log;
    error_log /var/log/nginx/api.hotwell.error.log;
}




