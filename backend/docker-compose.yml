version: '3.8'

services:
  backend:
    # Имя контейнера
    container_name: shorts-backend
    
    # Сборка образа из текущей директории (где находится Dockerfile)
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Порт можно задать через build arg, но лучше через env
        BACKEND_PORT: ${BACKEND_PORT:-3000}
    
    # Проброс портов: хост:контейнер
    # Используем переменную окружения BACKEND_PORT (по умолчанию 3000)
    ports:
      - "${BACKEND_PORT:-3000}:${BACKEND_PORT:-3000}"
    
    # Переменные окружения из файла .env.production (если существует)
    # Если файла нет, можно использовать env_file: .env
    env_file:
      - .env.production
    
    # Автоматический перезапуск при падении контейнера
    restart: always
    
    # Передаем PORT в контейнер (приложение использует переменную PORT)
    environment:
      - PORT=${BACKEND_PORT:-3000}
      - NODE_ENV=production
      # Suno API для Music Clips
      - SUNO_API_KEY=${SUNO_API_KEY:-}
      - SUNO_API_BASE_URL=${SUNO_API_BASE_URL:-https://api.suno.ai}
    
    # Монтирование volumes для сохранения данных на хосте
    # ВАЖНО: storage маппится на /app/storage внутри контейнера
    # На хосте: /volume1/docker/shortsai/backend/storage
    volumes:
      - ./storage:/app/storage
      - ./tmp:/app/tmp

