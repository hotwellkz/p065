# Итоговая инструкция: Настройка публичного HTTPS API

## 🎯 Цель

Поднять публичный HTTPS API домен `api.hotwell.synology.me` на VPS (159.255.37.158), который проксирует запросы через VPN туннель на Synology Backend (10.8.0.2:5001).

## ✅ Что будет настроено

1. **Nginx Reverse Proxy** на VPS
2. **SSL сертификат Let's Encrypt** для HTTPS
3. **Проксирование** через VPN туннель (10.8.0.1 → 10.8.0.2)
4. **Поддержка Range запросов** для видео (206 Partial Content)
5. **CORS заголовки** для API
6. **Firewall** (открыты только 80/443)

## 📋 Пошаговое выполнение

### Шаг 1: Подготовка файлов

Загрузите файлы на VPS:

```bash
# С Windows (PowerShell или CMD)
scp setup_vps_api.sh root@159.255.37.158:/root/
scp check_vps_status.sh root@159.255.37.158:/root/

# Или используйте WinSCP / FileZilla для загрузки файлов
```

### Шаг 2: Подключение к VPS

```bash
ssh root@159.255.37.158
```

### Шаг 3: Выполнение скрипта настройки

```bash
chmod +x /root/setup_vps_api.sh
/root/setup_vps_api.sh
```

**Что делает скрипт:**
- ✅ Проверяет ОС и VPN подключение
- ✅ Определяет порт backend (5001 или 5000)
- ✅ Устанавливает Nginx
- ✅ Настраивает firewall (ufw)
- ✅ Создает конфигурацию Nginx
- ✅ Проверяет DNS

**Важно:** Если скрипт сообщит о проблемах с VPN или backend - исправьте их перед продолжением!

### Шаг 4: Настройка DNS

**КРИТИЧНО:** DNS должен быть настроен ДО получения SSL сертификата!

1. Откройте панель управления DNS (где настроен домен `hotwell.synology.me`)
2. Создайте A-запись:
   - **Имя/Поддомен**: `api`
   - **Тип**: `A`
   - **Значение/IP**: `159.255.37.158`
   - **TTL**: `300` (или по умолчанию)

3. Проверьте распространение DNS:
   ```bash
   dig +short api.hotwell.synology.me
   # Должно вернуть: 159.255.37.158
   ```

**Подождите 5-10 минут** после создания записи для распространения DNS.

### Шаг 5: Получение SSL сертификата

После того как DNS распространился:

```bash
# Замените YOUR_EMAIL@example.com на ваш реальный email
certbot --nginx -d api.hotwell.synology.me \
  --non-interactive \
  --agree-tos \
  -m YOUR_EMAIL@example.com
```

Certbot автоматически:
- ✅ Получит SSL сертификат от Let's Encrypt
- ✅ Обновит конфигурацию Nginx
- ✅ Настроит автоматическое обновление сертификата

### Шаг 6: Проверка работы

#### С VPS:
```bash
# Проверка /health endpoint
curl -I https://api.hotwell.synology.me/health

# Должно вернуть: HTTP/2 200

# Детальная проверка
curl -v https://api.hotwell.synology.me/health
```

#### С внешнего устройства (4G/другой сети):
- Откройте в браузере: `https://api.hotwell.synology.me/health`
- Должен вернуться статус 200

#### Проверка Range запросов (для видео):
```bash
curl -r 0-1023 -I https://api.hotwell.synology.me/api/media/user/channel/file.mp4

# Должно вернуть:
# HTTP/1.1 206 Partial Content
# Accept-Ranges: bytes
# Content-Range: bytes 0-1023/...
```

## 🔍 Диагностика и проверка

### Полная проверка статуса

```bash
/root/check_vps_status.sh
```

### Проверка VPN подключения

```bash
ping -c 3 10.8.0.2
curl -v http://10.8.0.2:5001/health
```

### Проверка сервисов

```bash
systemctl status nginx
systemctl status certbot.timer
```

### Просмотр логов

```bash
# Ошибки Nginx
tail -f /var/log/nginx/error.log

# Доступ Nginx
tail -f /var/log/nginx/access.log
```

## 🛠️ Устранение проблем

### Проблема: ERR_CONNECTION_TIMED_OUT

**Причины:**
1. Firewall блокирует порты 80/443
2. DNS не настроен или не распространился
3. Nginx не запущен

**Решение:**
```bash
# 1. Проверьте firewall
ufw status
ufw allow 80/tcp
ufw allow 443/tcp

# 2. Проверьте DNS
dig +short api.hotwell.synology.me

# 3. Проверьте Nginx
systemctl status nginx
systemctl start nginx
```

### Проблема: 502 Bad Gateway

**Причины:**
- Backend недоступен через VPN
- Неправильный порт в конфигурации

**Решение:**
```bash
# Проверьте доступность backend
ping -c 3 10.8.0.2
curl -v http://10.8.0.2:5001/health

# Если не работает, проверьте другой порт
curl -v http://10.8.0.2:5000/health

# Если другой порт работает, обновите конфигурацию
nano /etc/nginx/sites-available/api.hotwell.synology.me
# Найдите proxy_pass и измените порт с 5001 на 5000 (или наоборот)
nginx -t
systemctl reload nginx
```

### Проблема: Range запросы не работают (206 не возвращается)

**Решение:**
Убедитесь, что в конфигурации Nginx есть:
```nginx
proxy_buffering off;
proxy_request_buffering off;
```

Проверьте логи:
```bash
tail -50 /var/log/nginx/error.log | grep -i range
```

### Проблема: VPN маршрут пропадает после перезагрузки

**Решение:**

Добавьте маршрут в системную конфигурацию:

**Для systemd-networkd:**
```bash
cat > /etc/systemd/network/10-vpn-route.network << EOF
[Route]
Destination=10.8.0.0/24
Gateway=10.8.0.1
EOF
systemctl restart systemd-networkd
```

**Для NetworkManager:**
```bash
nmcli connection modify <VPN_CONNECTION_NAME> ipv4.routes "10.8.0.0/24 10.8.0.1"
```

**Для /etc/network/interfaces:**
```bash
# Добавьте в /etc/network/interfaces:
up ip route add 10.8.0.0/24 dev tun0
```

## 📊 Итоговая схема

```
┌─────────────────────────────────────────────────────────┐
│                    Интернет (4G/любой)                   │
│  https://api.hotwell.synology.me                         │
└───────────────────────┬──────────────────────────────────┘
                        │ HTTPS (443)
                        │ DNS: 159.255.37.158
                        ↓
┌─────────────────────────────────────────────────────────┐
│  VPS Ubuntu 24.04 (159.255.37.158)                      │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Nginx Reverse Proxy                             │   │
│  │  - SSL/TLS (Let's Encrypt)                       │   │
│  │  - CORS заголовки                                │   │
│  │  - Range поддержка (206 Partial Content)         │   │
│  └───────────────────┬──────────────────────────────┘   │
│                      │ HTTP (5001)                       │
│                      │ VPN туннель                       │
└──────────────────────┼──────────────────────────────────┘
                       │
                       ↓
┌─────────────────────────────────────────────────────────┐
│  VPN Network (10.8.0.0/24)                              │
│  ┌──────────────────────────────────────────────────┐   │
│  │  VPS Gateway: 10.8.0.1                           │   │
│  └───────────────────┬──────────────────────────────┘   │
│                      │                                    │
│                      ↓                                    │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Synology DSM Backend: 10.8.0.2:5001            │   │
│  │  - /health endpoint                              │   │
│  │  - /api/media/... (видео файлы)                 │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

## 📁 Измененные файлы на VPS

После выполнения всех шагов на VPS будут созданы/изменены:

- `/etc/nginx/sites-available/api.hotwell.synology.me` - конфигурация Nginx
- `/etc/nginx/sites-enabled/api.hotwell.synology.me` - симлинк на sites-available
- `/etc/letsencrypt/live/api.hotwell.synology.me/` - SSL сертификаты
- `/var/log/nginx/error.log` - логи ошибок
- `/var/log/nginx/access.log` - логи доступа
- `/root/setup_vps_api.sh` - скрипт настройки
- `/root/check_vps_status.sh` - скрипт проверки

## ✅ Чеклист выполнения

- [ ] Файлы загружены на VPS
- [ ] Скрипт `setup_vps_api.sh` выполнен успешно
- [ ] VPN подключение работает (ping 10.8.0.2 успешен)
- [ ] Backend доступен (curl http://10.8.0.2:5001/health работает)
- [ ] DNS запись создана и распространилась
- [ ] SSL сертификат получен через certbot
- [ ] HTTPS работает снаружи (проверено с 4G)
- [ ] /health endpoint возвращает 200
- [ ] Range запросы работают (206 Partial Content)

## 🔒 Безопасность

- ✅ Порт 80/443 открыт только на VPS
- ✅ Домашний роутер НЕ открывает порты
- ✅ Все соединения через VPN туннель
- ✅ Используется валидный SSL сертификат (Let's Encrypt)
- ✅ Автоматическое обновление сертификатов настроено
- ⚠️ CORS настроен на "*" - при необходимости ограничьте для production

## 📞 Что делать если снова появится ERR_CONNECTION_TIMED_OUT

1. **Проверьте firewall:**
   ```bash
   ufw status
   ufw allow 80/tcp
   ufw allow 443/tcp
   ```

2. **Проверьте DNS:**
   ```bash
   dig +short api.hotwell.synology.me
   # Должно вернуть: 159.255.37.158
   ```

3. **Проверьте Nginx:**
   ```bash
   systemctl status nginx
   systemctl restart nginx
   ```

4. **Проверьте SSL сертификат:**
   ```bash
   certbot certificates
   # Если сертификат истек, обновите:
   certbot renew
   ```

5. **Проверьте логи:**
   ```bash
   tail -50 /var/log/nginx/error.log
   ```

6. **Проверьте VPN подключение:**
   ```bash
   ping -c 3 10.8.0.2
   curl -v http://10.8.0.2:5001/health
   ```

## 🎉 Готово!

После выполнения всех шагов ваш API будет доступен по адресу:
- **https://api.hotwell.synology.me/health** - health check
- **https://api.hotwell.synology.me/api/media/...** - медиа файлы с поддержкой Range

Все работает через VPN туннель, без открытия портов на домашнем роутере!




