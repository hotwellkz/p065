# Устранение проблем с таймаутами Telegram

## Проблема: TIMEOUT ошибки при работе с Telegram API

Если вы видите ошибки типа `Error: TIMEOUT` в логах, это означает, что соединение с серверами Telegram не устанавливается в течение допустимого времени.

## Что было сделано для улучшения

### 1. Увеличены таймауты подключения
- Таймаут подключения к Telegram: **30 секунд**
- Таймаут скачивания видео: **5 минут** (для больших файлов)
- Таймаут получения сообщений: **30 секунд**

### 2. Добавлены повторы подключения
- `connectionRetries: 5` - до 5 попыток переподключения
- Использование TCP вместо WebSocket (`useWSS: false`) для большей стабильности

### 3. Улучшена обработка ошибок
- Специальные сообщения для таймаутов
- Автоматическая очистка временных файлов при ошибках
- Детальное логирование для отладки

## Диагностика проблем

### Шаг 1: Проверка подключения к серверам Telegram

Запустите скрипт проверки:

```bash
node scripts/test-telegram-connection.js
```

Скрипт проверит доступность основных серверов Telegram:
- `149.154.167.41`
- `149.154.167.50`
- `149.154.175.50`
- `91.108.56.100`

### Шаг 2: Проверка настроек фаервола

Убедитесь, что исходящие соединения разрешены:
- **Порт 443 (HTTPS)** - основной порт для Telegram
- **Порт 80 (HTTP)** - резервный порт

### Шаг 3: Проверка прокси/VPN

Если вы используете прокси или VPN:
1. Убедитесь, что они не блокируют Telegram
2. Попробуйте временно отключить их
3. Проверьте настройки прокси в системе

### Шаг 4: Проверка антивируса/межсетевого экрана

Некоторые антивирусы и межсетевые экраны могут блокировать соединения:
1. Временно отключите антивирус
2. Добавьте исключение для Node.js процесса
3. Проверьте настройки Windows Firewall

## Решения

### Решение 1: Увеличение таймаутов (если проблема временная)

Если проблема связана с медленным интернетом, можно увеличить таймауты в коде:

**Файл:** `backend/src/telegram/client.ts`

```typescript
// Увеличить таймаут подключения до 60 секунд
await Promise.race([
  client.connect(),
  new Promise<never>((_, reject) => 
    setTimeout(() => reject(new Error("Connection timeout")), 60000) // 60 секунд
  )
]);
```

**Файл:** `backend/src/utils/telegramDownload.ts`

```typescript
// Увеличить таймаут скачивания до 10 минут
const downloadTimeout = 10 * 60 * 1000; // 10 минут
```

### Решение 2: Использование прокси (если Telegram заблокирован)

Если Telegram заблокирован в вашем регионе, настройте прокси:

**Файл:** `backend/src/telegram/client.ts`

```typescript
import { ProxyAgent } from "proxy-agent";

const client = new TelegramClient(session, apiId, apiHash, {
  connectionRetries: 5,
  useWSS: false,
  proxy: {
    socksType: 5, // SOCKS5
    ip: "your-proxy-ip",
    port: 1080,
    username: "optional-username",
    password: "optional-password"
  }
});
```

### Решение 3: Проверка DNS

Проблемы с DNS могут вызывать таймауты:

1. Попробуйте использовать публичные DNS:
   - Google DNS: `8.8.8.8`, `8.8.4.4`
   - Cloudflare DNS: `1.1.1.1`, `1.0.0.1`

2. Очистите DNS кэш:
   ```bash
   ipconfig /flushdns  # Windows
   ```

## Логирование

Все операции с Telegram логируются. Проверьте логи для деталей:

```
[INFO] - Starting video download from Telegram to temp file
[INFO] - Downloading media to buffer
[ERROR] - Error during Telegram media download to buffer
```

## Контакты и поддержка

Если проблема сохраняется:
1. Проверьте логи на наличие конкретных ошибок
2. Убедитесь, что все переменные окружения настроены правильно
3. Проверьте версию библиотеки `telegram` (должна быть актуальной)

## Связанные файлы

- `backend/src/telegram/client.ts` - настройки Telegram клиента
- `backend/src/utils/telegramDownload.ts` - скачивание видео с таймаутами
- `backend/src/routes/telegramRoutes.ts` - обработка ошибок таймаутов
- `backend/scripts/test-telegram-connection.js` - скрипт проверки подключения






