import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { X, Copy, RefreshCw, Loader2, Sparkles, Check } from "lucide-react";
import type { Channel } from "../domain/channel";
import {
  generateAutoIdeaAndScripts,
  generateDetailedScripts,
  type AutoGeneratedResult,
  type GenerationResponse
} from "../services/openaiScriptGenerator";
import {
  fetchLatestVideoToDrive,
  fetchAndSaveToServer,
  sendPromptToSyntx
} from "../api/telegram";
import { useChannelStore } from "../stores/channelStore";
import { useAuthStore } from "../stores/authStore";
import { updatePreferenceIndex, getCurrentPreferenceVariant } from "../utils/preferencesUtils";

interface AIAutoGenerateModalProps {
  isOpen: boolean;
  channel: Channel | null;
  onClose: () => void;
}

const AIAutoGenerateModal = ({
  isOpen,
  channel,
  onClose
}: AIAutoGenerateModalProps) => {
  const navigate = useNavigate();
  const { user } = useAuthStore((state) => ({ user: state.user }));
  const { updateChannel, fetchChannels, channels } = useChannelStore((state) => ({
    updateChannel: state.updateChannel,
    fetchChannels: state.fetchChannels,
    channels: state.channels
  }));
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [result, setResult] = useState<AutoGeneratedResult | null>(null);
  const [detailedResult, setDetailedResult] =
    useState<GenerationResponse | null>(null);
  const [copied, setCopied] = useState(false);
  const [copiedScriptIndex, setCopiedScriptIndex] = useState<number | null>(
    null
  );
  const [copiedVideoPrompt, setCopiedVideoPrompt] = useState(false);
  const [copiedFileTitle, setCopiedFileTitle] = useState(false);
  const [syntxSendStatus, setSyntxSendStatus] = useState<
    "idle" | "loading" | "sent" | "error"
  >("idle");
  const [syntxError, setSyntxError] = useState<string | null>(null);
  const [driveStatus, setDriveStatus] = useState<
    "idle" | "loading" | "success" | "error" | "telegram_session_invalid"
  >("idle");
  const [driveMessage, setDriveMessage] = useState<string | null>(null);
  const [driveWebViewLink, setDriveWebViewLink] = useState<string | null>(null);

  useEffect(() => {
    if (isOpen && channel) {
      setError(null);
      setResult(null);
      setDetailedResult(null);
      setSyntxSendStatus("idle");
      setSyntxError(null);
      setDriveStatus("idle");
      setDriveMessage(null);
      setDriveWebViewLink(null);
      void handleGenerate();
    } else {
      setResult(null);
      setDetailedResult(null);
      setError(null);
      setSyntxSendStatus("idle");
      setSyntxError(null);
      setDriveStatus("idle");
      setDriveMessage(null);
      setDriveWebViewLink(null);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isOpen, channel?.id]);

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ò–ò-–∏–¥–µ—é –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –∫–∞–Ω–∞–ª–∞.
   * 
   * –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø:
   * - –§—É–Ω–∫—Ü–∏–∏ generateAutoIdeaAndScripts –∏ generateDetailedScripts –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   *   –∏—Å–ø–æ–ª—å–∑—É—é—Ç Firebase —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ callOpenAIProxy
   * - –¢—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ user?.uid)
   * 
   * –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö:
   * - –ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –æ—à–∏–±–æ–∫
   * - –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
   * - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ [object Object]
   */
  const handleGenerate = async () => {
    if (!channel) {
      setError("–ö–∞–Ω–∞–ª –Ω–µ –≤—ã–±—Ä–∞–Ω");
      return;
    }
    
    if (!user?.uid) {
      setError("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.");
      return;
    }

    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–Ω–∞–ª –∏–∑ store, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ preferences
    await fetchChannels(user.uid);
    const currentChannel = channels.find((c) => c.id === channel.id) || channel;

    // –õ–æ–≥–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ preferences
    if (currentChannel.preferences) {
      const selectedVariant = getCurrentPreferenceVariant(currentChannel.preferences);
      console.log("üîç AIAutoGenerateModal - Current preferences:", {
        mode: currentChannel.preferences.mode,
        lastUsedIndex: currentChannel.preferences.lastUsedIndex,
        variantsCount: currentChannel.preferences.variants.length,
        variants: currentChannel.preferences.variants.map((v, i) => ({
          index: i,
          text: v.text.substring(0, 50) + "..."
        })),
        selectedVariant: selectedVariant.substring(0, 100) + "..."
      });
    }

    setLoading(true);
    setError(null);
    setResult(null);
    setDetailedResult(null);

    try {
      const mode = currentChannel.generationMode || "script";
      
      if (mode === "prompt" || mode === "video-prompt-only") {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏–ª–∏ —Ç–æ–ª—å–∫–æ videoPrompt
        // –ó–∞–ø—Ä–æ—Å –∫ /api/prompt/openai —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
        const generated = await generateDetailedScripts(currentChannel);
        setDetailedResult(generated);
      } else {
        // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        // –ó–∞–ø—Ä–æ—Å –∫ /api/prompt/openai —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
        const generated = await generateAutoIdeaAndScripts(currentChannel);
        setResult(generated);
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å preferences –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      if (currentChannel.preferences && currentChannel.preferences.mode === "cyclic") {
        const oldIndex = currentChannel.preferences.lastUsedIndex || 0;
        const updatedPreferences = updatePreferenceIndex(currentChannel.preferences);
        const newIndex = updatedPreferences?.lastUsedIndex || 0;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –∏–∑–º–µ–Ω–∏–ª—Å—è
        if (oldIndex !== newIndex) {
          const updatedChannel = {
            ...currentChannel,
            preferences: updatedPreferences
          };
          await updateChannel(user.uid, updatedChannel);
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–Ω–∞–ª—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          await fetchChannels(user.uid);
          
          console.log("‚úÖ AIAutoGenerateModal - Updated preferences index:", {
            oldIndex,
            newIndex,
            variantsCount: currentChannel.preferences.variants.length
          });
        }
      }
    } catch (err) {
      // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
      let errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–¥–µ—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
      
      if (err instanceof Error) {
        errorMessage = err.message;
      } else if (err && typeof err === "object") {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏–∑ fetch/axios –∏ –¥—Ä—É–≥–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        const errorObj = err as any;
        errorMessage =
          errorObj?.response?.data?.message ||
          errorObj?.response?.data?.error ||
          errorObj?.message ||
          errorObj?.error ||
          String(errorObj) ||
          errorMessage;
      } else if (typeof err === "string") {
        errorMessage = err;
      }
      
      // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      console.error("AI idea generation error:", err);
      
      setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  const handleCopyAll = async () => {
    if (detailedResult) {
      // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
      const textToCopy = detailedResult.scenarios
        .map(
          (scenario) =>
            `${scenario.title} (${scenario.durationSeconds} —Å–µ–∫):\n\n${scenario.steps
              .map(
                (step) =>
                  `${step.secondFrom}-${step.secondTo}—Å: ${step.description}${step.dialog.length > 0 ? `\n${step.dialog.map((d) => `${d.character}: "${d.text}"`).join("\n")}` : ""}`
              )
              .join("\n\n")}`
        )
        .join("\n\n---\n\n");

      try {
        await navigator.clipboard.writeText(textToCopy);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      } catch (err) {
        setError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞");
      }
      return;
    }

    if (!result) {
      return;
    }

    const textToCopy = `–ò–î–ï–Ø –†–û–õ–ò–ö–ê:\n${result.idea}\n\n${result.scripts
      .map((script, index) => `–°–¶–ï–ù–ê–†–ò–ô ${index + 1}:\n${script}`)
      .join("\n\n")}`;

    try {
      await navigator.clipboard.writeText(textToCopy);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      setError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞");
    }
  };

  const handleCopyVideoPrompt = async () => {
    if (!detailedResult?.videoPrompt) {
      return;
    }

    try {
      await navigator.clipboard.writeText(detailedResult.videoPrompt);
      setCopiedVideoPrompt(true);
      setTimeout(() => setCopiedVideoPrompt(false), 2000);
    } catch (err) {
      setError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞");
    }
  };

  const handleCopyFileTitle = async () => {
    if (!detailedResult?.fileTitle) {
      return;
    }

    try {
      await navigator.clipboard.writeText(detailedResult.fileTitle);
      setCopiedFileTitle(true);
      setTimeout(() => setCopiedFileTitle(false), 2000);
    } catch (err) {
      setError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞");
    }
  };

  const handleSendToSyntx = async () => {
    if (!detailedResult?.videoPrompt || !channel) {
      return;
    }

    setSyntxSendStatus("loading");
    setSyntxError(null);

    try {
      // –ü–µ—Ä–µ–¥–∞–µ–º channelId, —á—Ç–æ–±—ã backend –º–æ–≥ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫–æ–π —Ç–∏–ø Telegram –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
      await sendPromptToSyntx(detailedResult.videoPrompt, channel.id);
      setSyntxSendStatus("sent");
    } catch (err: any) {
      setSyntxSendStatus("error");
      
      const status = err?.response?.status || err?.response?.statusCode;
      const errorCode = err?.response?.data?.error;
      const errorMessage = err?.response?.data?.message;
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ 401 (–Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ - —ç—Ç–æ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Firebase)
      if (status === 401) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ Telegram
        if (errorCode === "Unauthorized" || errorMessage?.includes("token") || errorMessage?.includes("Authorization")) {
          setSyntxError("–°–µ—Å—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏—Å—Ç–µ–∫–ª–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç –µ—â—ë —Ä–∞–∑.");
          console.error("401 Unauthorized (Firebase auth) –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Syntx:", err?.response?.data);
          return;
        }
        // –ï—Å–ª–∏ —ç—Ç–æ TELEGRAM_SESSION_EXPIRED_NEED_RELOGIN, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∏–∂–µ –∫–∞–∫ –æ—à–∏–±–∫—É Telegram
      }
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Telegram (–Ω–µ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
      let userFriendlyMessage: string;
      
      if (errorCode === "TELEGRAM_SESSION_EXPIRED_NEED_RELOGIN") {
        userFriendlyMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–º–ø—Ç –≤ Syntx: —Å–µ—Å—Å–∏—è Telegram –∏—Å—Ç–µ–∫–ª–∞. –û—Ç–≤—è–∂–∏—Ç–µ Telegram –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∏ –ø—Ä–∏–≤—è–∂–∏—Ç–µ —Å–Ω–æ–≤–∞.";
      } else if (errorCode === "TELEGRAM_USER_NOT_CONNECTED") {
        userFriendlyMessage = "Telegram –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω. –ü—Ä–∏–≤—è–∂–∏—Ç–µ Telegram –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∞–∫–∫–∞—É–Ω—Ç–∞.";
      } else if (errorCode === "TELEGRAM_SESSION_NOT_INITIALIZED") {
        userFriendlyMessage = "Telegram —Å–µ—Å—Å–∏—è –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.";
      } else if (errorCode === "SYNX_CHAT_ID_NOT_CONFIGURED") {
        userFriendlyMessage = "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.";
      } else if (errorCode === "FAILED_TO_SEND_PROMPT") {
        userFriendlyMessage = errorMessage || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–º–ø—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
      } else if (errorMessage) {
        userFriendlyMessage = errorMessage;
      } else if (err?.message) {
        userFriendlyMessage = err.message;
      } else {
        userFriendlyMessage = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–æ–º–ø—Ç–∞ –≤ SyntX. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
      }
      
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Syntx:", {
        status,
        errorCode,
        errorMessage,
        channelId: channel?.id,
        channelTransport: channel?.generationTransport,
        fullError: err
      });
      
      setSyntxError(userFriendlyMessage);
    }
  };

  const handleFetchVideoToDrive = async () => {
    if (!channel) return;

    setDriveStatus("loading");
    setDriveMessage(null);

    try {
      // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏–∫–∞ –∏–∑ detailedResult.fileTitle
      const videoTitle = detailedResult?.fileTitle || null;

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      const result = await fetchAndSaveToServer(
        channel.id,
        undefined, // telegramMessageId - –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º, –∏—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤–∏–¥–µ–æ
        videoTitle || undefined // –ü–µ—Ä–µ–¥–∞—ë–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏–∫–∞ –¥–ª—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
      );

      if (result.status === "ok" || result.status === "success" || result.success === true) {
        setDriveStatus("success");
        setDriveMessage("üü¢ –í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä");
      } else {
        setDriveStatus("error");
        setDriveMessage(
          result.message ||
            "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        );
      }
    } catch (err: any) {
      setDriveStatus("error");
      
      const errorCode = err?.response?.data?.code || err?.response?.data?.error;
      const errorType = err?.response?.data?.errorType;
      const errorMessage = err?.response?.data?.message || err?.message;
      
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–∏–¥–µ–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", {
        status: err?.response?.status,
        errorCode,
        errorType,
        errorMessage,
        fullError: err
      });
      
      // –¢–û–ß–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ TELEGRAM_SESSION_INVALID (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ backend —è–≤–Ω–æ –≤–µ—Ä–Ω—É–ª —ç—Ç–æ—Ç –∫–æ–¥)
      if (errorCode === "TELEGRAM_SESSION_INVALID") {
        setDriveMessage(
          "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–∞—Ç—å –≤–∏–¥–µ–æ: —Å–µ—Å—Å–∏—è Telegram –±–æ–ª—å—à–µ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞. " +
          "–ó–∞–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞, –æ—Ç–≤—è–∂–∏—Ç–µ Telegram –∏ –ø—Ä–∏–≤—è–∂–∏—Ç–µ –µ–≥–æ –∑–∞–Ω–æ–≤–æ."
        );
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–ª–∞–≥ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        setDriveStatus("telegram_session_invalid");
        return;
      }
      
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ Telegram)
      if (errorCode === "TELEGRAM_DOWNLOAD_FAILED" || errorMessage?.includes("TELEGRAM_DOWNLOAD")) {
        setDriveMessage(
          errorMessage || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–∞—Ç—å –≤–∏–¥–µ–æ –∏–∑ Telegram. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏."
        );
      } else if (errorMessage) {
        setDriveMessage(errorMessage);
      } else {
        setDriveMessage(
          "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–∏–¥–µ–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        );
      }
    }
  };

  const handleCopyScript = async (scriptText: string, index: number) => {
    try {
      await navigator.clipboard.writeText(scriptText);
      setCopiedScriptIndex(index);
      setTimeout(() => setCopiedScriptIndex(null), 2000);
    } catch (err) {
      setError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞");
    }
  };

  if (!isOpen || !channel) {
    return null;
  }

  const handleBackdropClick = (e: React.MouseEvent<HTMLDivElement>) => {
    if (e.target === e.currentTarget && !loading) {
      onClose();
    }
  };

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"
      onClick={handleBackdropClick}
    >
      <div
        className="relative w-full max-w-4xl max-h-[90vh] overflow-y-auto rounded-2xl border border-white/10 bg-slate-900 text-white shadow-2xl"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className="sticky top-0 z-10 flex items-center justify-between border-b border-white/10 bg-slate-900/95 backdrop-blur-sm px-6 py-4">
          <div className="flex items-center gap-3">
            <Sparkles className="h-5 w-5 text-brand-light" />
            <h2 className="text-xl font-semibold">
              –ê–≤—Ç–æ–∏–¥–µ—è –æ—Ç –ò–ò –¥–ª—è –∫–∞–Ω–∞–ª–∞ "{channel.name}"
            </h2>
          </div>
          <button
            type="button"
            onClick={onClose}
            className="rounded-lg p-2 text-slate-400 transition hover:bg-slate-800 hover:text-white"
          >
            <X size={20} />
          </button>
        </div>

        {/* Content */}
        <div className="p-6">
          {loading && (
            <div className="flex flex-col items-center justify-center py-16">
              <Loader2 className="h-12 w-12 animate-spin text-brand-light" />
              <p className="mt-4 text-lg text-slate-300">
                –ò–ò –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—Ç –∏–¥–µ—é –∏ –ø–∏—à–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π...
              </p>
              <p className="mt-2 text-sm text-slate-500">
                –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥
              </p>
            </div>
          )}

          {error && (
            <div className="rounded-xl border border-red-500/30 bg-red-900/20 p-6">
              <p className="mb-4 text-red-200">{error}</p>
              <button
                type="button"
                onClick={handleGenerate}
                className="flex items-center gap-2 rounded-xl bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700"
              >
                <RefreshCw size={16} />
                –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
              </button>
            </div>
          )}

          {/* –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏) */}
          {result && !loading && (
            <div className="space-y-6">
              {/* Idea Section */}
              <div className="rounded-xl border border-white/10 bg-slate-800/40 p-6">
                <h3 className="mb-3 flex items-center gap-2 text-lg font-semibold text-brand-light">
                  <Sparkles size={20} />
                  –ò–¥–µ—è —Ä–æ–ª–∏–∫–∞
                </h3>
                <p className="text-slate-200 whitespace-pre-wrap">
                  {result.idea}
                </p>
              </div>

              {/* Scripts Section */}
              <div className="space-y-4">
                <h3 className="text-lg font-semibold text-white">–°—Ü–µ–Ω–∞—Ä–∏–∏:</h3>
                {result.scripts.map((script, index) => (
                  <div
                    key={index}
                    className="relative rounded-xl border border-white/10 bg-slate-800/40 p-6"
                  >
                    <div className="mb-3 flex items-center justify-between gap-2">
                      <span className="rounded-full bg-brand/20 px-3 py-1 text-sm font-semibold text-brand-light">
                        –°—Ü–µ–Ω–∞—Ä–∏–π {index + 1}
                      </span>
                      <button
                        type="button"
                        onClick={() => handleCopyScript(script, index)}
                        className="flex items-center gap-2 rounded-lg border border-white/10 bg-slate-700/50 px-3 py-1.5 text-xs font-medium text-slate-200 transition hover:border-brand/40 hover:bg-slate-700 hover:text-white"
                        title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π"
                      >
                        {copiedScriptIndex === index ? (
                          <>
                            <Check size={14} className="text-green-400" />
                            <span className="text-green-400">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</span>
                          </>
                        ) : (
                          <>
                            <Copy size={14} />
                            <span>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                          </>
                        )}
                      </button>
                    </div>
                    <p className="text-slate-200 whitespace-pre-wrap">
                      {script}
                    </p>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç (–¥–µ—Ç–∞–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏) */}
          {detailedResult && !loading && (
            <div className="space-y-6">
              {/* Scripts Section - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ —Ä–µ–∂–∏–º –Ω–µ video-prompt-only */}
              {detailedResult.scenarios.length > 0 &&
                detailedResult.mode !== "video-prompt-only" && (
                  <div className="space-y-4">
                    <h3 className="text-lg font-semibold text-white">–°—Ü–µ–Ω–∞—Ä–∏–∏:</h3>
                    {detailedResult.scenarios.map((scenario, scenarioIndex) => {
                  const scenarioText = `${scenario.title} (${scenario.durationSeconds} —Å–µ–∫):\n\n${scenario.steps
                    .map(
                      (step) =>
                        `${step.secondFrom}-${step.secondTo}—Å: ${step.description}${step.dialog.length > 0 ? `\n${step.dialog.map((d) => `${d.character}: "${d.text}"`).join("\n")}` : ""}`
                    )
                    .join("\n\n")}`;

                  return (
                    <div
                      key={scenarioIndex}
                      className="relative rounded-xl border border-white/10 bg-slate-800/40 p-6"
                    >
                      <div className="mb-4 flex items-center justify-between gap-2">
                        <div>
                          <h4 className="text-lg font-semibold text-brand-light">
                            {scenario.title}
                          </h4>
                          <span className="mt-1 inline-block rounded-full bg-brand/20 px-2 py-0.5 text-xs font-semibold text-brand-light">
                            {scenario.durationSeconds} —Å–µ–∫
                          </span>
                        </div>
                        <button
                          type="button"
                          onClick={() =>
                            handleCopyScript(scenarioText, scenarioIndex)
                          }
                          className="flex items-center gap-2 rounded-lg border border-white/10 bg-slate-700/50 px-3 py-1.5 text-xs font-medium text-slate-200 transition hover:border-brand/40 hover:bg-slate-700 hover:text-white"
                          title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π"
                        >
                          {copiedScriptIndex === scenarioIndex ? (
                            <>
                              <Check size={14} className="text-green-400" />
                              <span className="text-green-400">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</span>
                            </>
                          ) : (
                            <>
                              <Copy size={14} />
                              <span>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                            </>
                          )}
                        </button>
                      </div>

                      <div className="space-y-3">
                        {scenario.steps.map((step, stepIndex) => (
                          <div
                            key={stepIndex}
                            className="rounded-lg border border-white/5 bg-slate-900/40 p-4"
                          >
                            <div className="mb-2 flex items-center gap-2">
                              <span className="rounded bg-brand/20 px-2 py-1 text-xs font-semibold text-brand-light">
                                {step.secondFrom}-{step.secondTo}—Å
                              </span>
                            </div>
                            <p className="mb-2 text-sm text-slate-200">
                              {step.description}
                            </p>
                            {step.dialog.length > 0 && (
                              <div className="mt-3 space-y-1 border-t border-white/5 pt-3">
                                {step.dialog.map((line, dialogIndex) => (
                                  <div
                                    key={dialogIndex}
                                    className="text-sm text-slate-300"
                                  >
                                    <span className="font-semibold text-brand-light">
                                      {line.character}:
                                    </span>{" "}
                                    <span className="italic">"{line.text}"</span>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                    })}
                  </div>
                )}

              {/* –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ video-prompt-only, –µ—Å–ª–∏ –Ω–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ */}
              {detailedResult.mode === "video-prompt-only" &&
                detailedResult.scenarios.length === 0 && (
                  <div className="rounded-xl border border-white/10 bg-slate-900/60 p-6 text-center">
                    <p className="text-slate-400">
                      –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ —Å—Ü–µ–Ω–∞—Ä–∏–π –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è, —Ç–æ–ª—å–∫–æ –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–∏–¥–µ–æ.
                    </p>
                  </div>
                )}

              {/* –ë–ª–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ (–¥–ª—è —Ä–µ–∂–∏–º–∞ video-prompt-only) */}
              {detailedResult.fileTitle && (
                <div className="mb-4 rounded-xl border border-slate-700 bg-slate-800/60 px-4 py-3">
                  <div className="flex items-center justify-between gap-3">
                    <div className="flex-1 min-w-0">
                      <div className="mb-1 text-xs uppercase tracking-wide text-slate-400">
                        –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏–∫–∞ / —Ñ–∞–π–ª–∞
                      </div>
                      <div className="break-all text-sm font-medium text-slate-50">
                        {detailedResult.fileTitle}
                      </div>
                    </div>
                    <button
                      type="button"
                      onClick={handleCopyFileTitle}
                      disabled={!detailedResult.fileTitle}
                      className="shrink-0 flex items-center gap-1.5 rounded-lg bg-brand px-3 py-1.5 text-xs font-medium text-white transition hover:bg-brand-dark disabled:cursor-not-allowed disabled:opacity-50"
                    >
                      {copiedFileTitle ? (
                        <>
                          <Check size={14} />
                          <span>–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</span>
                        </>
                      ) : (
                        <>
                          <Copy size={14} />
                          <span>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                        </>
                      )}
                    </button>
                  </div>
                </div>
              )}

              {/* VIDEO_PROMPT –±–ª–æ–∫ (–¥–ª—è —Ä–µ–∂–∏–º–æ–≤ "prompt" –∏ "video-prompt-only") */}
              {detailedResult.videoPrompt && (
                <div className="rounded-xl border border-brand/30 bg-brand/5 p-6">
                  <div className="mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                    <h3 className="text-lg font-semibold text-brand-light">
                      üé¨ –ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ
                    </h3>
                    <div className="flex flex-wrap items-center gap-2">
                      <button
                        type="button"
                        onClick={handleCopyVideoPrompt}
                        className="flex items-center gap-2 rounded-lg border border-brand/30 bg-brand/10 px-3 py-1.5 text-xs font-medium text-brand-light transition hover:bg-brand/20"
                      >
                        <Copy size={14} />
                        {copiedVideoPrompt ? "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!" : "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"}
                      </button>
                      <button
                        type="button"
                        onClick={handleSendToSyntx}
                        disabled={syntxSendStatus === "loading"}
                        className="flex items-center gap-2 rounded-lg border border-emerald-500/30 bg-emerald-500/10 px-3 py-1.5 text-xs font-medium text-emerald-300 transition hover:bg-emerald-500/20 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        {syntxSendStatus === "loading" ? (
                          <>
                            <Loader2 size={14} className="animate-spin" />
                            –û—Ç–ø—Ä–∞–≤–∫–∞...
                          </>
                        ) : syntxSendStatus === "sent" ? (
                          <>
                            <Check size={14} />
                            –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úî
                          </>
                        ) : (
                          <>
                            <Sparkles size={14} />
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ SyntX
                          </>
                        )}
                      </button>
                      {syntxSendStatus === "sent" && (
                        <button
                          type="button"
                          onClick={handleFetchVideoToDrive}
                          disabled={driveStatus === "loading"}
                          className="flex items-center gap-2 rounded-lg border border-white/20 bg-slate-900/60 px-3 py-1.5 text-xs font-medium text-slate-100 transition hover:border-brand/40 hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          {driveStatus === "loading" ? (
                            <>
                              <Loader2 size={14} className="animate-spin" />
                              –ó–∞–±–∏—Ä–∞–µ–º –≤–∏–¥–µ–æ...
                            </>
                          ) : driveStatus === "success" ? (
                            <>
                              <Check size={14} />
                              –í–∏–¥–µ–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                            </>
                          ) : (
                            <>
                              <Sparkles size={14} />
                              –ó–∞–±—Ä–∞—Ç—å –≤–∏–¥–µ–æ –∏–∑ SyntX –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                            </>
                          )}
                        </button>
                      )}
                    </div>
                  </div>
                  <textarea
                    readOnly
                    value={detailedResult.videoPrompt}
                    rows={12}
                    className="w-full rounded-lg border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-slate-200 outline-none"
                  />
                  {syntxSendStatus === "sent" && !syntxError && (
                    <p className="mt-2 text-xs text-emerald-300">
                      ‚úì –ü—Ä–æ–º–ø—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ SyntX —á–µ—Ä–µ–∑ Telegram
                    </p>
                  )}
                  {syntxSendStatus === "error" && syntxError && (
                    <p className="mt-2 text-xs text-red-300">{syntxError}</p>
                  )}
                  {syntxSendStatus === "idle" && (
                    <p className="mt-2 text-xs text-slate-400">
                      –ì–æ—Ç–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è Sora / Veo 3.1 Fast. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏
                      –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤ SyntX.
                    </p>
                  )}
                  {driveStatus === "success" && driveMessage && (
                    <p className="mt-2 text-xs text-emerald-300">
                      {driveMessage}
                    </p>
                  )}
                  {driveStatus === "error" && driveMessage && (
                    <p className="mt-2 text-xs text-red-300">{driveMessage}</p>
                  )}
                  {driveStatus === "telegram_session_invalid" && (
                    <div className="mt-2 rounded-lg border border-amber-500/30 bg-amber-900/20 p-3">
                      <p className="text-xs text-amber-300">{driveMessage}</p>
                      <button
                        type="button"
                        onClick={() => navigate("/settings")}
                        className="mt-2 rounded-lg bg-amber-500/20 px-3 py-1.5 text-xs font-medium text-amber-300 transition hover:bg-amber-500/30"
                      >
                        –ü–µ—Ä–µ–π—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
                      </button>
                    </div>
                  )}
                </div>
              )}
            </div>
          )}

          {/* Action Buttons */}
          {(result || detailedResult) && !loading && (
            <div className="mt-6 flex flex-wrap gap-3 border-t border-white/10 pt-6">
              <button
                type="button"
                onClick={handleCopyAll}
                className="flex items-center gap-2 rounded-xl bg-brand px-5 py-3 text-sm font-semibold text-white transition hover:bg-brand-dark"
              >
                {copied ? (
                  <>
                    <Check size={16} />
                    –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!
                  </>
                ) : (
                  <>
                    <Copy size={16} />
                    –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë
                  </>
                )}
              </button>
              <button
                type="button"
                onClick={handleGenerate}
                disabled={loading}
                className="flex items-center gap-2 rounded-xl border border-white/10 bg-slate-800/60 px-5 py-3 text-sm font-semibold text-slate-200 transition hover:border-brand/40 hover:text-white disabled:cursor-not-allowed disabled:opacity-50"
              >
                <RefreshCw size={16} className={loading ? "animate-spin" : ""} />
                –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
              </button>
              <button
                type="button"
                onClick={onClose}
                className="ml-auto rounded-xl border border-white/10 bg-slate-800/60 px-5 py-3 text-sm font-semibold text-slate-200 transition hover:border-brand/40 hover:text-white"
              >
                –ó–∞–∫—Ä—ã—Ç—å
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default AIAutoGenerateModal;

